<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomePower Switch ‚Äì Energ√≠a bajo control en tu hogar</title>
  <meta name="description" content="HomePower Switch: Paneles el√©ctricos y Transfer Switch Autom√°ticos (ATS) a pedido en Florida. Compatibles con EcoFlow y otros generadores. Proyecto a medida seg√∫n voltaje, conexiones y protecciones." />

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(15,26,51,.72);
      --text:#e9eefc;
      --muted:#b7c3e6;
      --line:rgba(255,255,255,.10);
      --accent:#63b3ff;
      --accent2:#7cffc9;
      --danger:#ff6b6b;
      --ok:#7cffc9;
      --shadow:0 10px 30px rgba(0,0,0,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background: var(--bg);
      line-height:1.45;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:22px; position:relative; z-index:1;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 0;gap:14px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brandText{display:flex;flex-direction:column}
    .brandText b{font-size:18px;letter-spacing:.4px}
    .brandText span{font-size:12px;color:var(--muted)}
    /* CAMBIO: logotipo m√°s grande */
    .logo{
      width:86px;height:86px;object-fit:contain;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:8px;
    }
    .navlinks{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      transition:transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      font-weight:650; cursor:pointer;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.18)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(99,179,255,.95), rgba(124,255,201,.85));
      color:#041022;border:0;
    }
    .btn.small{padding:9px 12px;border-radius:10px;font-size:13px}
    .btn.disabled{opacity:.45;pointer-events:none}

    h1{font-size:34px;line-height:1.1;margin:0 0 10px}
    h2{font-size:22px;margin:0 0 10px}
    h3{font-size:16px;margin:0 0 8px}
    p{margin:0 0 10px;color:var(--muted)}
    ul{margin:8px 0 0 18px;color:var(--muted)}
    li{margin:6px 0}

    .hero{padding:10px 0 0}
    .heroGrid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;align-items:stretch}
    @media (max-width:900px){.heroGrid{grid-template-columns:1fr}}
    .section{padding:14px 0}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:900px){.grid3{grid-template-columns:1fr}}

    .kpi{
      display:flex;flex-direction:column;gap:6px;
      padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);
    }
    .kpi b{font-size:16px}
    .kpi span{font-size:12px;color:var(--muted)}

    .note{
      font-size:12px;color:var(--muted);
      border-left:3px solid rgba(124,255,201,.55);
      padding-left:10px;margin-top:10px
    }
    .warn{
      border-left:3px solid rgba(255,107,107,.7);
      padding-left:10px;font-size:12px;color:var(--muted)
    }
    .info{
      border-left:3px solid rgba(99,179,255,.7);
      padding-left:10px;font-size:12px;color:var(--muted)
    }

    .optionsWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.optionsWrap{grid-template-columns:1fr}}
    .optCard{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:14px;
    }
    .optLabel{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-weight:800;
      margin-bottom:8px;
    }
    .optLabelLeft{display:flex;align-items:center;gap:8px}
    .optLabel .dash{
      display:inline-grid;place-items:center;
      width:22px;height:22px;border-radius:8px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:900;
    }
    .optRow{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      transition:background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .chip:hover{background:rgba(255,255,255,.09);transform:translateY(-1px)}
    .chip.active{
      background:linear-gradient(135deg, rgba(99,179,255,.95), rgba(124,255,201,.85));
      color:#041022;border-color:transparent;
      font-weight:850;
    }
    .linkTiny{
      font-size:12px;color:var(--text);
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      padding:7px 10px;border-radius:999px;
      cursor:pointer;
      white-space:nowrap;
    }
    .linkTiny:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.18)}
    .hintTiny{font-size:12px;color:var(--muted);margin-top:8px}

    .contact{
      display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;
    }
    @media (max-width:900px){.contact{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}

    /* Dropdown legible */
    select{
      background-color:rgba(10,16,30,.92);
      color:var(--text);
    }
    select option{
      background-color:#0b1220;
      color:#e9eefc;
    }

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .resultBox{
      border:1px dashed rgba(124,255,201,.45);
      background:rgba(124,255,201,.06);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }

    .footer{
      padding:18px 0 30px;color:var(--muted);font-size:12px;
      display:flex;gap:12px;align-items:center;flex-wrap:wrap
    }
    .footer .logo{width:44px;height:44px;border-radius:14px}

    .statusRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .statusPill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);font-size:12px;color:var(--muted)
    }
    .statusPill.ok{border-color:rgba(124,255,201,.45)}
    .statusPill.bad{border-color:rgba(255,107,107,.55)}
    .statusPill.warn{border-color:rgba(255,200,107,.55)}

    .divider{height:1px;background:var(--line);margin:12px 0}

    /* Biblioteca visible */
    .libGrid{
      display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px;
    }
    @media (max-width:1000px){.libGrid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.libGrid{grid-template-columns:1fr}}
    .libCard{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .libCard:hover{transform:translateY(-2px);background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.18)}
    .libThumb{
      width:100%;height:140px;object-fit:cover;display:block;
      background:rgba(255,255,255,.04);
    }
    .libBody{padding:12px}
    .libTitle{font-weight:850;margin:0 0 6px}
    .libMeta{font-size:12px;color:var(--muted);margin:0}

    /* Modal galer√≠a */
    .modalBack{
      position:fixed;inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(980px, 100%);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(12,18,34,.96);
      border-radius:18px;
      box-shadow:0 30px 80px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modalTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .modalTop b{font-size:14px}
    .modalBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .modalBtn{
      padding:9px 11px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);cursor:pointer;font-weight:750;font-size:13px;
    }
    .modalBtn:hover{background:rgba(255,255,255,.10)}
    .modalMain{
      display:grid;grid-template-columns:1.2fr .8fr;gap:0;
    }
    @media (max-width:900px){.modalMain{grid-template-columns:1fr}}
    .modalBig{
      padding:12px;
      border-right:1px solid rgba(255,255,255,.12);
    }
    @media (max-width:900px){.modalBig{border-right:0;border-bottom:1px solid rgba(255,255,255,.12)}}
    .modalBig img{
      width:100%;max-height:520px;object-fit:contain;
      background:rgba(255,255,255,.03);
      border-radius:14px;border:1px solid rgba(255,255,255,.10);
    }
    .modalSide{padding:12px}
    .thumbRow{display:flex;flex-wrap:wrap;gap:10px}
    .thumb{
      width:96px;height:72px;object-fit:cover;
      border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      opacity:.9;
    }
    .thumb:hover{opacity:1}
    .thumb.active{outline:2px solid rgba(124,255,201,.65);opacity:1}

    /* Validaci√≥n */
    .fieldMsg{
      font-size:12px;margin-top:6px;
      color:var(--muted);
    }
    .fieldMsg.bad{color:#ffb3b3}
    .fieldMsg.ok{color:#b9ffd9}

    /* CAMBIO: ocultar indicadores en la primera p√°gina (no visibles) */
    .statusRow{display:none !important;}

    /* ===== Fondo con slideshow usando TODAS las fotos (b + c) ===== */
    .bgLayer{
      position:fixed;
      inset:0;
      z-index:-3;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      transform:scale(1.02);
      opacity:0;
      transition:opacity 1.2s ease;
    }
    .bgLayer.on{ opacity:1; }

    .bgOverlay{
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(99,179,255,.16), transparent 60%),
        radial-gradient(800px 520px at 85% 15%, rgba(124,255,201,.12), transparent 55%),
        linear-gradient(rgba(11,18,32,.82), rgba(11,18,32,.86));
    }
  </style>
</head>

<body>
  <!-- FONDO SLIDESHOW (usa todas las fotos) -->
  <div class="bgLayer" id="bgA" aria-hidden="true"></div>
  <div class="bgLayer" id="bgB" aria-hidden="true"></div>
  <div class="bgOverlay" aria-hidden="true"></div>

  <div class="wrap">
    <!-- NAV -->
    <div class="nav">
      <div class="brand">
        <!-- Coloca logotipo.png en la misma carpeta que este index.html -->
        <img class="logo" src="logotipo.png" alt="HomePower Switch Logo" />
        <div class="brandText">
          <b>HomePower Switch</b>
          <span>Energ√≠a bajo control en tu hogar.</span>
        </div>
      </div>

      <div class="navlinks">
        <a class="btn small" href="#inicio">Inicio</a>
        <a class="btn small" href="#que">Qu√© puedes solicitar</a>
        <a class="btn small" href="#personalizacion">Personalizaci√≥n</a>
        <a class="btn small" href="#contacto">Contacto</a>
        <a class="btn small" href="#proyecto">Solicitar proyecto</a>
        <a class="btn small" href="#opciones">Selecciona opciones</a>
        <a class="btn small" href="#biblioteca">Biblioteca</a>
      </div>
    </div>

    <!-- HERO -->
    <div id="inicio" class="hero">
      <div class="heroGrid">
        <!-- Historia + CTA -->
        <div class="card">
          <h1>Paneles el√©ctricos y Transfer Switch Autom√°ticos (ATS) a pedido ¬∑ Florida</h1>
          <p><b>HomePower Switch: energ√≠a bajo control en tu hogar.</b></p>

          <p>
            HomePower Switch nace de una necesidad real: que la energ√≠a del hogar no dependa de improvisaciones, sino de un
            <b>cambio seguro, ordenado y bien dise√±ado</b> entre la red el√©ctrica y un sistema de respaldo.
          </p>

          <p>
            El nombre refleja exactamente lo que hacemos: <b>Home</b>, porque cada proyecto se dise√±a para la vivienda real;
            <b>Power</b>, porque la energ√≠a debe estar protegida y correctamente distribuida; y <b>Switch</b>, porque el cambio
            entre fuentes debe hacerse de forma inteligente, autom√°tica y segura.
          </p>

          <p>
            Dise√±amos y construimos <b>paneles el√©ctricos y ATS a pedido</b>, compatibles con EcoFlow y otros generadores,
            definidos seg√∫n voltaje (110 V o 220 V), tipo de conector NEMA, longitudes y nivel de protecci√≥n requerido.
          </p>

          <p>
            Cada proyecto puede incluir protecci√≥n contra <b>bajo y alto voltaje</b>, retardo de reconexi√≥n, toma de servicio
            protegida para carga y opciones informativas, con un enfoque claro:
            <b>proteger tu instalaci√≥n y mantener continuidad energ√©tica de forma confiable</b>.
          </p>

          <p class="note">
            Si tienes dudas sobre tu caso espec√≠fico, lo aclaramos directamente en tu proyecto y te brindaremos asesor√≠a t√©cnica antes de construir.
          </p>

          <!-- CAMBIO: los indicadores no deben verse (statusRow oculto por CSS) -->
          <div class="statusRow">
            <span id="dbStatus" class="statusPill">Base de precios: cargando‚Ä¶</span>
            <span id="sendStatus" class="statusPill warn">Env√≠o: bloqueado (faltan datos)</span>
          </div>

          <!-- CAMBIO: Botones de contacto SOLO comunicaci√≥n (sin texto extra generado) -->
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
            <button class="btn primary" id="btnPedir">Pedir mi sistema</button>
            <a class="btn" href="tel:+17865998225" aria-label="Llamar a (786) 599-8225">üìû (786) 599-8225</a>
            <a class="btn" href="mailto:jorgedanlm@gmail.com" aria-label="Enviar correo a jorgedanlm@gmail.com">üìß jorgedanlm@gmail.com</a>
            <a class="btn primary" id="btnWhatsAppTop" href="#" rel="noopener" aria-label="Abrir WhatsApp">WhatsApp</a>
          </div>

          <p class="note">
            Tiempo t√≠pico de fabricaci√≥n: <b>7 a 30 d√≠as</b> (seg√∫n complejidad). Garant√≠a: <b>30 a 60 d√≠as</b>.
            Precio final depende del dise√±o y componentes seleccionados.
          </p>
        </div>

        <!-- Nota 220V -->
        <div class="card">
          <h2>Aclaraci√≥n importante: Proyectos 220 V</h2>
          <p class="info">
            Los proyectos <b>220 V</b> est√°n pensados para viviendas que usan <b>dos fases diferentes</b> dentro de la casa,
            funcionando cada una a <b>110 V con su neutro</b> (configuraci√≥n com√∫n en Cuba).
          </p>
          <p class="info">
            Si se utiliza un <b>generador 110 V</b>, solo se tendr√° <b>una fase de 110 V con su neutro</b>, lo que significa
            que circular√° dentro del hogar <b>una sola fase</b> durante el respaldo.
          </p>
          <p class="warn">
            Si existe alg√∫n equipo que trabaje con <b>220 V</b>, se debe <b>dejar fuera</b> de este sistema de respaldo.
            Cualquier duda, ind√≠cala directamente en tu proyecto y te brindaremos asesor√≠a t√©cnica.
          </p>
        </div>
      </div>
    </div>

    <!-- QU√â PUEDES SOLICITAR -->
    <div id="que" class="section">
      <div class="card">
        <h2>Qu√© puedes solicitar</h2>
        <div class="grid3" style="margin-top:10px">
          <div class="kpi">
            <b>1) Panel transfer switch autom√°tico</b>
            <span>Con protecci√≥n de voltaje para todo el hogar o solo en el servicio de carga (EcoFlow o generador)</span>
          </div>
          <div class="kpi">
            <b>2) Conexiones</b>
            <span>Conector NEMA (5-15P o TT-30P), 110/220 V y longitudes</span>
          </div>
          <div class="kpi">
            <b>3) Protecciones</b>
            <span>Voltaje bajo/alto con retardo 1‚Äì3 min, general o dedicada</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PERSONALIZACI√ìN -->
    <div id="personalizacion" class="section">
      <div class="card">
        <h2>Personalizaci√≥n (a pedido)</h2>
        <ul>
          <li><b>Tipo de conector NEMA:</b> 5-15P o TT-30P</li>
          <li><b>Voltaje del sistema:</b> 110 V o 220 V</li>
          <li><b>Protecci√≥n de voltaje:</b> bajo/alto con <b>retardo</b> (1 a 3 min)</li>
          <li><b>Toma de servicio protegida para carga:</b> incluida (EcoFlow o generador)</li>
          <li><b>Longitudes:</b> entrante (1‚Äì5 ft), saliente (1‚Äì5 ft), EcoFlow/generador (4‚Äì8 ft), toma servicio (1‚Äì8 ft)</li>
          <li><b>Pantalla informativa:</b> opcional</li>
        </ul>
        <p class="warn" style="margin-top:10px">
          Componentes sobre riel DIN 35mm. Proyecto a pedido con especificaci√≥n del cliente y asesor√≠a profesional.
        </p>
      </div>
    </div>

    <!-- CAMBIO: mover "Contacto directo" y "Qu√© incluir..." ANTES de "Solicitar proyecto" -->
    <div id="contacto" class="section">
      <div class="card">
        <h2>Contacto directo</h2>
        <p><b>Tel√©fono:</b> (786) 599-8225</p>
        <p><b>Correo:</b> jorgedanlm@gmail.com</p>
        <p><b>Zona:</b> Florida</p>

        <div class="divider"></div>

        <h2>Qu√© incluir para realizar proyecto m√°s r√°pido</h2>
        <ul>
          <li>Equipo (marca y modelo)</li>
          <li>Nivel de protecci√≥n (parcial / total)</li>
          <li>Voltaje del sistema (110 V / 220 V)</li>
          <li>Conector NEMA (5-15P o TT-30P)</li>
          <li>Protecci√≥n bajo/alto y retardo (1 a 3 min)</li>
          <li>Longitudes: entrante (1‚Äì5), saliente (1‚Äì5), EcoFlow/generador (4‚Äì8), toma de servicio (1‚Äì8)</li>
          <li>Opcional: pantalla informativa</li>
          <li>Direcci√≥n completa con ZIP Code</li>
        </ul>
      </div>
    </div>

    <!-- SOLICITAR PROYECTO -->
    <div id="proyecto" class="section">
      <div class="card">
        <h2>Solicitar proyecto</h2>
        <p>Completa tus datos. Luego seleccionas opciones t√©cnicas. Al final se genera el resumen con precio listo para enviar.</p>

        <div class="contact" style="margin-top:10px">
          <div>
            <label>Nombre (obligatorio)</label>
            <input id="name" placeholder="Tu nombre" />
            <div id="msgName" class="fieldMsg"></div>

            <label>N√∫mero telef√≥nico (obligatorio)</label>
            <input id="phone" placeholder="Ej.: 7865998225" inputmode="tel" />
            <div id="msgPhone" class="fieldMsg"></div>

            <label>Equipo / Generador (marca y modelo) (obligatorio)</label>
            <input id="equipment" placeholder="Ej.: EcoFlow Delta Pro / Honda EU2200i / (marca y modelo)" />
            <div id="msgEquip" class="fieldMsg"></div>

            <label>Nivel de protecci√≥n de voltaje (obligatorio)</label>
            <select id="goal">
              <option value="">‚Äî Seleccionar ‚Äî</option>
              <!-- CAMBIO: eliminado el sub-men√∫ inicial -->
              <option value="Protecci√≥n de voltaje parcial (solo toma de servicio para carga del EcoFlow o generador)">
                Protecci√≥n de voltaje parcial (solo toma de servicio para carga del EcoFlow o generador)
              </option>
              <option value="Protecci√≥n de voltaje total (toma de servicio para carga del EcoFlow o generador + toda la casa)">
                Protecci√≥n de voltaje total (toma de servicio para carga del EcoFlow o generador + toda la casa)
              </option>
            </select>
            <div id="msgGoal" class="fieldMsg"></div>

            <label>Direcci√≥n del pedido (entrega o ubicaci√≥n del proyecto) (obligatorio)</label>
            <input id="address" placeholder="Ej.: 1234 NW 56th St, Apt 3B (3er piso), Miami, FL, Estados Unidos, 33142" />
            <div id="msgAddress" class="fieldMsg"></div>

            <label>Detalles adicionales (obligatorio)</label>
            <textarea
              id="details"
              placeholder="Describe informaci√≥n adicional √∫til para tu proyecto: tipo de vivienda (casa/apto), cargas prioritarias, limitaciones el√©ctricas conocidas, preferencia de ubicaci√≥n del panel, condiciones especiales del sitio, etc."
            ></textarea>
            <div id="msgDetails" class="fieldMsg"></div>

            <p class="note">
              En el siguiente paso seleccionar√°s opciones del sistema. Cuando todo est√© completo, ver√°s el resumen final con total estimado y clasificaci√≥n.
            </p>
          </div>

          <div>
            <h2>Gu√≠a r√°pida</h2>
            <p class="info">
              Completa el formulario y luego ve a <b>Selecciona opciones</b>. Cuando el proyecto est√© completo, se habilitar√°n los botones de env√≠o al final.
            </p>
            <p class="note">
              Recomendaci√≥n: escribe la direcci√≥n con comas e incluye ZIP Code (5 d√≠gitos).
            </p>
          </div>
        </div>

        <div class="divider"></div>
        <p class="hintTiny">
          Siguiente paso: <a class="linkTiny" href="#opciones">Selecciona opciones</a>
        </p>
      </div>
    </div>

    <!-- SELECCIONA OPCIONES -->
    <div id="opciones" class="section">
      <div class="card">
        <h2>Selecciona opciones</h2>
        <p>Toca las opciones para incluirlas autom√°ticamente en tu <b>proyecto</b> y calcular el costo total.</p>

        <div class="optionsWrap" style="margin-top:10px">
          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Voltaje del sistema</div>
              <button class="linkTiny" data-lib-open="voltaje">Ver fotos</button>
            </div>
            <div class="optRow">
              <span class="chip" data-group="volt" data-value="110 V">110 V</span>
              <span class="chip" data-group="volt" data-value="220 V">220 V</span>
            </div>
            <div class="hintTiny">Obligatorio.</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Conector NEMA (EcoFlow/Generador)</div>
              <button class="linkTiny" data-lib-open="nema">Ver fotos</button>
            </div>
            <div class="optRow">
              <span class="chip" data-group="nema" data-value="NEMA 5-15P">NEMA 5-15P</span>
              <span class="chip" data-group="nema" data-value="NEMA TT-30P">NEMA TT-30P</span>
            </div>
            <div class="hintTiny">Obligatorio.</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Pies cable ENTRANTE (panel‚Üícasa)</div>
            </div>
            <div class="optRow" id="lenInRow"></div>
            <div class="hintTiny">Obligatorio (1‚Äì5 ft).</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Pies cable SALIENTE (panel‚Üícasa)</div>
            </div>
            <div class="optRow" id="lenOutRow"></div>
            <div class="hintTiny">Obligatorio (1‚Äì5 ft).</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Pies cable EcoFlow/Generador (interconexi√≥n)</div>
              <button class="linkTiny" data-lib-open="ats">Ver fotos</button>
            </div>
            <div class="optRow" id="lenGenRow"></div>
            <div class="hintTiny">Obligatorio (4‚Äì8 ft).</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Protecci√≥n (alcance)</div>
              <button class="linkTiny" data-lib-open="protector">Ver fotos</button>
            </div>
            <div class="optRow">
              <span class="chip" data-group="prot" data-value="General (todo el hogar)">General (todo el hogar)</span>
              <span class="chip" data-group="prot" data-value="Dedicada (solo toma de servicio)">Dedicada (solo toma de servicio)</span>
            </div>
            <div class="hintTiny">Obligatorio.</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Retardo de reconexi√≥n (calle)</div>
            </div>
            <div class="optRow">
              <span class="chip" data-group="delay" data-value="1 min">1 min</span>
              <span class="chip" data-group="delay" data-value="2 min">2 min</span>
              <span class="chip" data-group="delay" data-value="3 min">3 min</span>
            </div>
            <div class="hintTiny">Obligatorio (1‚Äì3 min).</div>
          </div>

          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Pantalla informativa (opcional)</div>
              <button class="linkTiny" data-lib-open="monitor">Ver fotos</button>
            </div>
            <div class="optRow">
              <span class="chip" data-group="screen" data-value="SI">S√≠</span>
              <span class="chip" data-group="screen" data-value="NO">No</span>
            </div>
          </div>

          <!-- Toma de servicio (incluida) -->
          <div class="optCard">
            <div class="optLabel">
              <div class="optLabelLeft"><span class="dash">-</span> Toma de servicio para carga (NEMA 5-20R) (incluida)</div>
              <button class="linkTiny" data-lib-open="nema520r">Ver fotos</button>
            </div>
            <p class="hintTiny" style="margin:0 0 10px 0">
              Esta toma de servicio protegida queda incluida. Selecciona el largo del cable.
            </p>
            <div class="optLabel" style="margin-top:10px">
              <div class="optLabelLeft"><span class="dash">-</span> Pies cable toma de servicio</div>
            </div>
            <div class="optRow" id="lenServiceRow"></div>
            <div class="hintTiny">Obligatorio (1‚Äì8 ft).</div>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
          <button class="btn primary" id="btnBuild">Actualizar proyecto</button>
          <span class="statusPill" id="selectionStatus">Selecci√≥n: incompleta</span>
        </div>

        <div id="finalResultBox" class="resultBox" style="display:none">
          <b>Clasificaci√≥n del proyecto:</b> <span id="finalClass" class="mono"></span><br/>
          <b>Total estimado:</b> <span id="finalTotal" class="mono"></span><br/>
          <b>Resumen listo para enviar:</b>
          <div id="finalText" class="mono" style="white-space:pre-wrap;margin-top:8px"></div>

          <div class="divider"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <a class="btn" id="btnEmail" href="#">Enviar por correo</a>
            <a class="btn primary" id="btnWhatsApp" href="#" rel="noopener">Enviar por WhatsApp</a>
          </div>

          <p class="note" id="sendHint">
            Para habilitar el env√≠o debes completar: nombre, tel√©fono, equipo (marca/modelo), nivel de protecci√≥n, direcci√≥n completa y detalles.
          </p>
        </div>

        <p class="note">
          El total se calcula leyendo <b>pricedb.csv</b> (exportado desde tu Excel). Si cambias precios en Excel, exportas de nuevo y reemplazas el CSV.
        </p>
      </div>
    </div>

    <!-- BIBLIOTECA VISIBLE -->
    <div id="biblioteca" class="section">
      <div class="card">
        <h2>Biblioteca de componentes (referencia visual)</h2>
        <p>
          Esta galer√≠a ayuda a identificar los equipos y componentes usados en el proyecto.
          Puedes tocar cualquier tarjeta para ver las fotos.
        </p>

        <div id="libGrid" class="libGrid"></div>

        <p class="note">
          En el futuro podr√°s agregar m√°s im√°genes subi√©ndolas a la carpeta <span class="mono">images/library/</span> y actualizando <span class="mono">library.json</span>.
        </p>
      </div>
    </div>

    <div class="footer">
      <img class="logo" src="logotipo.png" alt="HomePower Switch Logo" />
      <div>
        ¬© <span id="year"></span> <b>HomePower Switch</b> ¬∑ Florida ¬∑ (786) 599-8225 ¬∑ jorgedanlm@gmail.com
      </div>
    </div>
  </div>

  <!-- MODAL GALER√çA -->
  <div id="modalBack" class="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Galer√≠a de im√°genes">
      <div class="modalTop">
        <b id="modalTitle">Galer√≠a</b>
        <div class="modalBtns">
          <button class="modalBtn" id="modalPrev">‚óÄ</button>
          <button class="modalBtn" id="modalNext">‚ñ∂</button>
          <button class="modalBtn" id="modalClose">Cerrar</button>
        </div>
      </div>

      <div class="modalMain">
        <div class="modalBig">
          <img id="modalBigImg" alt="Imagen de galer√≠a" src="" />
        </div>
        <div class="modalSide">
          <div id="thumbRow" class="thumbRow"></div>
          <p class="hintTiny" style="margin-top:10px">
            Nota: Las im√°genes son referenciales para apoyar el proyecto. Para dudas t√©cnicas, ind√≠calas en el formulario.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================
    // CONFIG
    // =============================
    const PHONE_E164 = "17865998225";
    const EMAIL = "jorgedanlm@gmail.com";

    // =============================
    // FONDO SLIDESHOW (usa TODAS las fotos)
    // =============================
    // Coloca tus im√°genes aqu√≠:
    // /images/background/fondo-1.png
    // /images/background/fondo-2.jpg
    // ...
    const BG_IMAGES = [
  "images/background/fondo-1.png",
  "images/background/fondo-2.jpg",
  "images/background/fondo-3.jpg",
  "images/background/fondo-4.jpg",
  "images/background/fondo-5.webp",
  "images/background/fondo-6.jpeg",
  "images/background/fondo-7.jpg",
  "images/background/fondo-8.jpg"
];

function preloadImage(src){
  return new Promise((resolve, reject) => {
    const im = new Image();
    im.onload = () => resolve(src);
    im.onerror = () => reject(src);
    im.src = src;
  });
}

async function startBackgroundSlideshow(){
  const a = document.getElementById("bgA");
  const b = document.getElementById("bgB");
  if (!a || !b || !BG_IMAGES.length) return;

  // Preload con diagn√≥stico
  const ok = [];
  const bad = [];
  for (const src of BG_IMAGES){
    try{
      await preloadImage(src);
      ok.push(src);
    }catch(e){
      bad.push(src);
    }
  }

  console.log("BG OK:", ok);
  console.warn("BG FAIL:", bad);

  // Si ninguna carga, salimos
  if (!ok.length){
    console.error("No carg√≥ ninguna imagen de fondo. Revisa rutas/nombres.");
    return;
  }

  let idx = 0;
  let showA = true;

  a.style.backgroundImage = `url("${ok[idx]}")`;
  a.classList.add("on");

  setInterval(() => {
    idx = (idx + 1) % ok.length;
    const next = ok[idx];

    if (showA){
      b.style.backgroundImage = `url("${next}")`;
      b.classList.add("on");
      a.classList.remove("on");
    } else {
      a.style.backgroundImage = `url("${next}")`;
      a.classList.add("on");
      b.classList.remove("on");
    }
    showA = !showA;
  }, 9000);
}

    // =============================
    // HELPERS
    // =============================
    function $(id){ return document.getElementById(id); }
    function normWordsCount(text){
      const t = (text || "").trim();
      if (!t) return 0;
      return t.split(/\s+/).filter(Boolean).length;
    }
    function digitsOnly(s){ return (s || "").replace(/[^\d]/g, ""); }

    // =============================
    // 1) PRICE DB (pricedb.csv)
    // =============================
    let PRICE_DB = [];
    let DB_READY = false;

    async function loadPriceDB(url = "pricedb.csv") {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("No pude cargar pricedb.csv. Verifica que est√© junto a index.html");
      const text = await res.text();

      const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length);
      const headers = lines[0].split(",").map(h => h.trim());

      return lines.slice(1).map(line => {
        const parts = line.split(",");
        const row = {};
        headers.forEach((h, i) => row[h] = (parts[i] ?? "").trim());

        row.group_id = Number(row.group_id || 0);
        row.qty = Number(row.qty || 0);
        row.unit_price = Number(row.unit_price || 0);

        row.price_unit = (row.price_unit || "").trim();
        row.condition = (row.condition || "").trim();
        row.depends_on = (row.depends_on || "").trim();
        return row;
      });
    }

    function matchesCondition(rowCond, ctx) {
      if (!rowCond || rowCond.toLowerCase() === "siempre") return true;

      const parts = rowCond.split(/\s+AND\s+/i).map(s => s.trim());
      return parts.every(expr => {
        const [k, v] = expr.split("=").map(x => (x || "").trim());
        if (!k) return false;
        const ctxVal = (ctx[k] ?? "").toString().trim();
        return ctxVal === v;
      });
    }

    function rowCost(row, ctx) {
      if (!matchesCondition(row.condition, ctx)) return 0;

      if (row.price_unit === "each") {
        return (row.qty || 0) * (row.unit_price || 0);
      }

      if (row.price_unit === "per_ft") {
        const dep = (row.depends_on || "").trim();
        let feet = 0;

        if (dep.includes("+")) {
          feet = dep.split("+").map(x => Number(ctx[x.trim()] || 0)).reduce((a,b) => a + b, 0);
        } else {
          feet = Number(ctx[dep] || 0);
        }

        return (row.unit_price || 0) * feet * ((row.qty || 1));
      }

      return 0;
    }

    function calcTotalFromDB(ctx) {
      return PRICE_DB.reduce((sum, row) => sum + rowCost(row, ctx), 0);
    }

    // =============================
    // 2) STATE (selecciones)
    // =============================
    const state = {
      volt: "",
      nema: "",
      lenIn: "",
      lenOut: "",
      lenGen: "",
      prot: "",
      delay: "",
      screen: "",
      lenService: ""
    };

    function ensureOneSelected(group){
      document.querySelectorAll(`.chip[data-group="${group}"]`).forEach(ch => ch.classList.remove("active"));
      const chosen = document.querySelector(`.chip[data-group="${group}"][data-value="${state[group]}"]`);
      if (chosen) chosen.classList.add("active");
    }

    function bindChips(){
      document.querySelectorAll(".chip").forEach(chip=>{
        chip.addEventListener("click", ()=>{
          const group = chip.getAttribute("data-group");
          const value = chip.getAttribute("data-value");

          state[group] = (state[group] === value) ? "" : value;
          ensureOneSelected(group);

          refreshAll();
        });
      });
    }

    function makeLengthChips(containerId, group, from, to, suffix){
      const row = $(containerId);
      for (let i=from;i<=to;i++){
        const span = document.createElement("span");
        span.className = "chip";
        span.setAttribute("data-group", group);
        span.setAttribute("data-value", `${i} ${suffix}`);
        span.textContent = `${i} ${suffix}`;
        row.appendChild(span);
      }
    }

    function isCompleteSelection(){
      if (!DB_READY) return false;

      const required = [
        state.volt,
        state.nema,
        state.lenIn,
        state.lenOut,
        state.lenGen,
        state.prot,
        state.delay,
        state.screen,
        state.lenService
      ];
      return !required.some(v => !v);
    }

    function buildCtx(){
      const volt = (state.volt === "110 V") ? "110" : (state.volt === "220 V") ? "220" : "";
      const lenToNum = (s)=> parseInt((s || "0").split(" ")[0], 10) || 0;

      return {
        voltaje: volt,
        conector: state.nema || "",
        pantalla: state.screen || "NO",
        toma_servicio: "SI",
        len_in: lenToNum(state.lenIn),
        len_out: lenToNum(state.lenOut),
        len_gen: lenToNum(state.lenGen),
        len_service: lenToNum(state.lenService)
      };
    }

    function classify(total){
      if (total >= 330) return "AVANZADO";
      if (total >= 260) return "EST√ÅNDAR";
      return "B√ÅSICO";
    }

    // =============================
    // 3) VALIDACI√ìN
    // =============================
    function setFieldMsg(id, ok, text){
      const el = $(id);
      el.textContent = text || "";
      el.classList.remove("ok","bad");
      if (text) el.classList.add(ok ? "ok" : "bad");
    }

    function validateName(){
      const v = ($("name").value || "").trim();
      if (v.length < 2) { setFieldMsg("msgName", false, "Requerido."); return false; }
      setFieldMsg("msgName", true, "OK"); return true;
    }

    function validatePhone(){
      const raw = $("phone").value || "";
      const d = digitsOnly(raw);
      const ok = (d.length === 10) || (d.length === 11 && d.startsWith("1"));
      if (!ok) { setFieldMsg("msgPhone", false, "Requerido (10 d√≠gitos)."); return false; }
      setFieldMsg("msgPhone", true, "OK"); return true;
    }

    function validateEquipment(){
      const v = ($("equipment").value || "").trim();
      if (v.length < 4) { setFieldMsg("msgEquip", false, "Requerido (marca y modelo)."); return false; }
      setFieldMsg("msgEquip", true, "OK"); return true;
    }

    function validateGoal(){
      const v = ($("goal").value || "").trim();
      if (!v) { setFieldMsg("msgGoal", false, "Requerido."); return false; }
      setFieldMsg("msgGoal", true, "OK"); return true;
    }

    function validateAddress(){
      const v = ($("address").value || "").trim();
      const zipOk = /\b\d{5}\b/.test(v);
      const lenOk = v.length >= 18;
      const commaOk = v.includes(",");
      const ok = lenOk && zipOk && commaOk;
      if (!ok) { setFieldMsg("msgAddress", false, "Requerida (incluye comas y ZIP Code de 5 d√≠gitos)."); return false; }
      setFieldMsg("msgAddress", true, "OK"); return true;
    }

    function validateDetails(){
      const v = ($("details").value || "").trim();
      const wc = normWordsCount(v);
      if (wc < 1) { setFieldMsg("msgDetails", false, "Requerido (m√≠nimo 1 palabra)."); return false; }
      if (wc <= 10) setFieldMsg("msgDetails", true, `OK (${wc} palabra${wc===1?"":"s"})`);
      else setFieldMsg("msgDetails", true, `OK (${wc} palabras)`);
      return true;
    }

    function validatePersonalBlock(){
      const ok =
        validateName() &
        validatePhone() &
        validateEquipment() &
        validateGoal() &
        validateAddress() &
        validateDetails();
      return !!ok;
    }

    function canSend(){
      return DB_READY && isCompleteSelection() && validatePersonalBlock();
    }

    // =============================
    // 4) RESUMEN FINAL + LINKS
    // =============================
    function buildFinalText(total, cls){
      const name = ($("name").value || "").trim() || "[Tu nombre]";
      const phone = digitsOnly($("phone").value || "").trim() || "[Tel√©fono]";
      const equipment = ($("equipment").value || "").trim() || "[Marca y modelo]";
      const protection = ($("goal").value || "").trim() || "[Nivel de protecci√≥n]";
      const address = ($("address").value || "").trim() || "[Direcci√≥n completa + ZIP Code]";
      const extra = ($("details").value || "").trim() || "[Detalles adicionales]";

      const lines = [
        `PROYECTO HomePower Switch`,
        `Cliente: ${name}`,
        `Tel√©fono: ${phone}`,
        `Equipo/Generador: ${equipment}`,
        `Nivel de protecci√≥n: ${protection}`,
        `Direcci√≥n del pedido: ${address}`,
        ``,
        `Selecciones t√©cnicas:`,
        `- Voltaje del sistema: ${state.volt || "[No seleccionado]"}`,
        `- Conector NEMA (EcoFlow/Generador): ${state.nema || "[No seleccionado]"}`,
        `- Pies cable ENTRANTE: ${state.lenIn || "[No seleccionado]"}`,
        `- Pies cable SALIENTE: ${state.lenOut || "[No seleccionado]"}`,
        `- Pies cable EcoFlow/Generador: ${state.lenGen || "[No seleccionado]"}`,
        `- Protecci√≥n (alcance): ${state.prot || "[No seleccionado]"}`,
        `- Retardo reconexi√≥n: ${state.delay || "[No seleccionado]"}`,
        `- Pantalla informativa: ${state.screen || "[No seleccionado]"}`,
        `- Toma de servicio protegida (incluida): NEMA 5-20R`,
        `- Pies cable toma de servicio: ${state.lenService || "[No seleccionado]"}`,
        ``,
        `Clasificaci√≥n del proyecto: ${cls}`,
        `Total estimado: $${Math.round(total)}`,
        ``,
        `Detalles adicionales:`,
        extra,
        ``,
        `Nota 220V: Si tu vivienda usa dos fases de 110V (cada una con neutro), un generador 110V respaldar√° solo una fase. Equipos 220V deben quedar fuera del respaldo.`
      ];

      return lines.join("\n");
    }

    // CAMBIO: los botones de contacto del HERO no deben ‚Äúcargar texto‚Äù.
    // Por eso NO tocamos btnWhatsAppTop aqu√≠.
    function setLinks(finalText){
      const wa = "https://wa.me/" + PHONE_E164 + "?text=" + encodeURIComponent(finalText);
      const mail = "mailto:" + EMAIL
        + "?subject=" + encodeURIComponent("Proyecto HomePower Switch - Panel/ATS a pedido")
        + "&body=" + encodeURIComponent(finalText);

      $("btnWhatsApp").href = wa;
      $("btnEmail").href = mail;
    }

    function setDBStatus(ok, msg){
      const el = $("dbStatus");
      el.textContent = msg;
      el.classList.remove("ok","bad","warn");
      el.classList.add(ok ? "ok" : "bad");
    }

    function setSendStatus(){
      const el = $("sendStatus");
      if (canSend()){
        el.textContent = "Env√≠o: listo";
        el.classList.remove("warn","bad"); el.classList.add("ok");
      } else {
        el.textContent = "Env√≠o: bloqueado (faltan datos)";
        el.classList.remove("ok","bad"); el.classList.add("warn");
      }
    }

    function setSelectionStatus(){
      const el = $("selectionStatus");
      if (!DB_READY){
        el.textContent = "Selecci√≥n: esperando base de precios";
        return;
      }
      el.textContent = isCompleteSelection() ? "Selecci√≥n: completa" : "Selecci√≥n: incompleta";
      el.classList.remove("ok","bad","warn");
      el.classList.add(isCompleteSelection() ? "ok" : "warn");
    }

    function refreshFinalBox(){
      const finalBox = $("finalResultBox");
      const ready = DB_READY && isCompleteSelection();

      setSelectionStatus();

      if (!ready){
        finalBox.style.display = "none";
        return;
      }

      const ctx = buildCtx();
      const total = calcTotalFromDB(ctx);
      const cls = classify(total);
      const text = buildFinalText(total, cls);

      $("finalClass").textContent = cls;
      $("finalTotal").textContent = `$${Math.round(total)}`;
      $("finalText").textContent = text;

      finalBox.style.display = "block";
      setLinks(text);

      const okToSend = canSend();
      $("btnEmail").classList.toggle("disabled", !okToSend);
      $("btnWhatsApp").classList.toggle("disabled", !okToSend);

      setSendStatus();
    }

    function refreshAll(){
      ["volt","nema","lenIn","lenOut","lenGen","prot","delay","screen","lenService"].forEach(g => ensureOneSelected(g));
      refreshFinalBox();
    }

    function goToProject(){
      $("proyecto").scrollIntoView({ behavior:"smooth", block:"start" });
      setTimeout(()=> $("name")?.focus(), 450);
    }

    // =============================
    // 5) BIBLIOTECA VISIBLE (library.json)
    // =============================
    const LIB_SPECS = [
      { key:"ats",        title:"ATS (Transfer Switch Autom√°tico)", slug:"ats", hint:"Cambio autom√°tico entre fuentes.", defaultImages:["ATS 1.jpg","ATS 2.jpg"] },
      { key:"nema515p",   title:"NEMA 5-15P ‚Äì Conector",            slug:"nema-5-15p", hint:"Conector est√°ndar 15A/125V.", defaultImages:["conector nema 5 - 15P.jpg"] },
      { key:"nematt30p",  title:"NEMA TT-30P ‚Äì Conector",           slug:"nema-tt-30p", hint:"Conector RV 30A.", defaultImages:["conextor nema tt-30P.jpg"] },
      { key:"breaker2p",  title:"Breaker dos polos",                slug:"breaker-2p", hint:"Protecci√≥n interna / DIN.", defaultImages:["Breker 1.avif","breker 2.avif"] },
      { key:"breaker3p",  title:"Breaker tres polos",               slug:"breaker-3p", hint:"Para configuraci√≥n requerida.", defaultImages:["breker 3.avif","breker 2.avif"] },
      { key:"protector",  title:"Protector de voltaje (alto/bajo)", slug:"protector", hint:"Bajo/alto voltaje + protecci√≥n.", defaultImages:["protector de voltaje.avif","protector de voltaje 2.avif"] },
      { key:"monitor",    title:"Monitor de CA (6 en 1)",           slug:"monitor", hint:"Pantalla informativa.", defaultImages:["monitor.avif"] },
      { key:"nema520r",   title:"Toma de servicio ‚Äì NEMA 5-20R",     slug:"nema-5-20r", hint:"Servicio protegido para carga.", defaultImages:["conector nema 5-20R.jpg"] },

      { key:"voltaje",    title:"Voltaje del sistema",              slug:"voltaje", hint:"Referencia visual (si aplica).", defaultImages:[] },
      { key:"nema",       title:"Conectores NEMA (referencia)",      slug:"nema", hint:"Resumen visual de conectores.", defaultImages:[] },
    ];

    let LIB = {};

    async function loadLibraryJson(){
      const res = await fetch("library.json", { cache:"no-store" });
      if (!res.ok) throw new Error("No se encontr√≥ library.json");
      return await res.json();
    }

    function buildLibraryFromSources(libJson){
      const out = {};
      for (const spec of LIB_SPECS){
        const listFromJson = libJson && libJson[spec.slug];
        const images = Array.isArray(listFromJson) ? listFromJson : spec.defaultImages;

        out[spec.key] = {
          title: spec.title,
          slug: spec.slug,
          hint: spec.hint,
          images: images.map(fn => `images/library/${spec.slug}/${fn}`)
        };
      }
      return out;
    }

    function pickThumb(images){
      return images && images.length ? images[0] : "";
    }

    function renderLibraryGrid(){
      const grid = $("libGrid");
      grid.innerHTML = "";

      const shownKeys = ["ats","nema515p","nematt30p","breaker2p","breaker3p","protector","monitor","nema520r"];
      for (const key of shownKeys){
        const item = LIB[key];
        const thumb = pickThumb(item.images);
        const count = item.images.length;

        const card = document.createElement("div");
        card.className = "libCard";
        card.setAttribute("data-open-lib", key);

        const img = document.createElement("img");
        img.className = "libThumb";
        img.alt = item.title;
        img.src = thumb || "";
        if (!thumb){
          img.style.height = "140px";
          img.style.objectFit = "contain";
        }

        const body = document.createElement("div");
        body.className = "libBody";
        body.innerHTML = `
          <div class="libTitle">${item.title}</div>
          <p class="libMeta">${item.hint} ¬∑ ${count} imagen${count===1?"":"es"}</p>
        `;

        card.appendChild(img);
        card.appendChild(body);
        grid.appendChild(card);

        card.addEventListener("click", ()=> openGallery(key));
      }
    }

    // =============================
    // 6) MODAL GALER√çA
    // =============================
    let galleryState = { key:"", idx:0 };

    function openGallery(key){
      const item = LIB[key];
      if (!item || !item.images || !item.images.length){
        return;
      }
      galleryState.key = key;
      galleryState.idx = 0;

      $("modalTitle").textContent = item.title;
      renderGallery();
      $("modalBack").style.display = "flex";
      $("modalBack").setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeGallery(){
      $("modalBack").style.display = "none";
      $("modalBack").setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    function renderGallery(){
      const item = LIB[galleryState.key];
      const imgs = item.images;
      const idx = Math.max(0, Math.min(galleryState.idx, imgs.length-1));
      galleryState.idx = idx;

      $("modalBigImg").src = imgs[idx];

      const row = $("thumbRow");
      row.innerHTML = "";
      imgs.forEach((src,i)=>{
        const t = document.createElement("img");
        t.className = "thumb" + (i===idx ? " active" : "");
        t.src = src;
        t.alt = item.title + " " + (i+1);
        t.addEventListener("click", ()=>{ galleryState.idx = i; renderGallery(); });
        row.appendChild(t);
      });
    }

    function nextImg(){
      const item = LIB[galleryState.key];
      if (!item || !item.images.length) return;
      galleryState.idx = (galleryState.idx + 1) % item.images.length;
      renderGallery();
    }
    function prevImg(){
      const item = LIB[galleryState.key];
      if (!item || !item.images.length) return;
      galleryState.idx = (galleryState.idx - 1 + item.images.length) % item.images.length;
      renderGallery();
    }

    // =============================
    // INIT
    // =============================
    async function init(){
      // fondo
      startBackgroundSlideshow();

      // longitudes
      makeLengthChips("lenInRow", "lenIn", 1, 5, "ft");
      makeLengthChips("lenOutRow","lenOut",1, 5, "ft");
      makeLengthChips("lenGenRow","lenGen",4, 8, "ft");
      makeLengthChips("lenServiceRow","lenService",1, 8, "ft");

      bindChips();

      // defaults
      state.volt = "110 V";
      state.nema = "NEMA 5-15P";
      state.lenIn = "1 ft";
      state.lenOut = "1 ft";
      state.lenGen = "4 ft";
      state.prot = "Dedicada (solo toma de servicio)";
      state.delay = "1 min";
      state.screen = "NO";
      state.lenService = "1 ft";

      // listeners
      ["name","phone","equipment","address","details"].forEach(id=>{
        $(id)?.addEventListener("input", ()=>{ validatePersonalBlock(); refreshAll(); });
      });
      $("goal")?.addEventListener("change", ()=>{ validatePersonalBlock(); refreshAll(); });

      $("btnBuild").addEventListener("click", ()=>{ validatePersonalBlock(); refreshAll(); });
      $("btnPedir").addEventListener("click", ()=>{ goToProject(); validatePersonalBlock(); refreshAll(); });

      // a√±o
      $("year").textContent = new Date().getFullYear();

      // WhatsApp TOP: SIEMPRE solo abrir chat (sin texto prellenado)
      $("btnWhatsAppTop").href = "https://wa.me/" + PHONE_E164;

      // cargar CSV precios
      try{
        setDBStatus(false, "Base de precios: cargando‚Ä¶");
        PRICE_DB = await loadPriceDB("pricedb.csv");
        DB_READY = true;
        setDBStatus(true, "Base de precios: lista (pricedb.csv)");
      }catch(err){
        DB_READY = false;
        setDBStatus(false, "Base de precios: ERROR (falta pricedb.csv)");
        console.error(err);
      }

      // cargar biblioteca
      let libJson = null;
      try{
        libJson = await loadLibraryJson();
      }catch(e){
        libJson = null;
      }
      LIB = buildLibraryFromSources(libJson);
      renderLibraryGrid();

      // Botones "Ver fotos" en opciones
      document.querySelectorAll("[data-lib-open]").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const key = btn.getAttribute("data-lib-open");

          if (key === "voltaje") openGallery("voltaje");
          else if (key === "nema") {
            if (state.nema === "NEMA 5-15P") openGallery("nema515p");
            else if (state.nema === "NEMA TT-30P") openGallery("nematt30p");
            else openGallery("nema515p");
          } else if (key === "ats") openGallery("ats");
          else if (key === "protector") openGallery("protector");
          else if (key === "monitor") openGallery("monitor");
          else if (key === "nema520r") openGallery("nema520r");
        });
      });

      // modal events
      $("modalClose").addEventListener("click", closeGallery);
      $("modalNext").addEventListener("click", nextImg);
      $("modalPrev").addEventListener("click", prevImg);
      $("modalBack").addEventListener("click", (e)=>{ if (e.target === $("modalBack")) closeGallery(); });
      document.addEventListener("keydown", (e)=>{
        if ($("modalBack").style.display !== "flex") return;
        if (e.key === "Escape") closeGallery();
        if (e.key === "ArrowRight") nextImg();
        if (e.key === "ArrowLeft") prevImg();
      });

      // primera validaci√≥n
      validatePersonalBlock();
      refreshAll();
    }

    init();
  </script>
</body>
</html>
